generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   @default("admin")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String
  isActive     Boolean        @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  bookings     Booking[]
  notifications Notification[]
}

model Tour {
  id String @id @default(uuid())

  // Multi-language fields
  title_ka       String
  title_en       String
  title_ru       String
  description_ka String
  description_en String
  description_ru String
  location_ka    String?
  location_en    String?
  location_ru    String?

  // Legacy fields
  title       String @default("")
  slug        String @unique
  description String @default("")

  // Non-translatable fields
  price    Float?
  duration String
  status   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  images   TourImage[]
  bookings Booking[]
}

model Booking {
  id             String               @id @default(uuid())
  userId         String?
  guestName      String?
  guestEmail     String?
  guestPhone     String?
  tourId         String?
  desiredDate    DateTime?
  adults         Int?
  children       Int?
  roomType       RoomType?
  hotelName      String?
  hotelCheckIn   DateTime?
  hotelCheckOut  DateTime?
  hotelRoomType  String?
  hotelGuests    Int?
  hotelNotes     String?
  totalPrice     Float                @default(0)
  amountPaid     Float                @default(0)
  note           String?
  adminNote      String?
  serviceStatus  BookingServiceStatus @default(PENDING)
  status         BookingStatus        @default(PENDING)
  approvedAt     DateTime?
  rejectedAt     DateTime?
  cancelledAt    DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  user           User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tour           Tour?                @relation(fields: [tourId], references: [id], onDelete: Restrict)
  changeRequests BookingChangeRequest[]

  @@index([desiredDate, status])
  @@index([userId, createdAt])
  @@index([tourId, desiredDate])
}

model BookingChangeRequest {
  id            String                     @id @default(uuid())
  bookingId     String
  requestedDate DateTime
  reason        String?
  status        BookingChangeRequestStatus @default(PENDING)
  adminNote     String?
  resolvedAt    DateTime?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt
  booking       Booking                    @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId, status])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  isRead    Boolean          @default(false)
  readAt    DateTime?
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}

model EmailLog {
  id             String         @id @default(uuid())
  recipientEmail String
  template       String
  payload        Json?
  status         EmailLogStatus
  error          String?
  createdAt      DateTime       @default(now())
}

model TourImage {
  id        String   @id @default(uuid())
  url       String
  publicId  String
  tourId    String
  createdAt DateTime @default(now())

  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@index([tourId])
}

model BlogPost {
  id   String @id @default(uuid())
  slug String @unique

  title_ka String
  title_en String
  title_ru String

  excerpt_ka String
  excerpt_en String
  excerpt_ru String

  content_ka String
  content_en String
  content_ru String

  author_ka String
  author_en String
  author_ru String

  coverImage  String
  published   Boolean   @default(false)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RoomType {
  single
  double
  twin
  triple
  family
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum BookingServiceStatus {
  PENDING
  COMPLETED
}

enum BookingChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_APPROVED
  BOOKING_REJECTED
  BOOKING_CANCELLED
  BOOKING_CHANGE_REQUESTED
  BOOKING_CHANGE_APPROVED
  BOOKING_CHANGE_REJECTED
}

enum EmailLogStatus {
  SENT
  FAILED
  FALLBACK_LOGGED
}